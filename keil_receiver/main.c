#include "stm32f4xx_hal.h"
#include "stm32f4xx.h"
#include "LCD16x2Lib/LCD.h"
#include "math.h"

//input_range = [0.0, 0.031415926535897934, 0.06283185307179587, 0.09424777960769379, 0.12566370614359174, 0.15707963267948966, 0.18849555921538758, 0.21991148575128552, 0.25132741228718347, 0.2827433388230814, 0.3141592653589793, 0.34557519189487723, 0.37699111843077515, 0.4084070449666731, 0.43982297150257105, 0.4712388980384689, 0.5026548245743669, 0.5340707511102649, 0.5654866776461628, 0.5969026041820606, 0.6283185307179586, 0.6597344572538566, 0.6911503837897545, 0.7225663103256523, 0.7539822368615503, 0.7853981633974483, 0.8168140899333463, 0.8482300164692441, 0.8796459430051421, 0.9110618695410401, 0.9424777960769378, 0.9738937226128358, 1.0053096491487339, 1.0367255756846319, 1.0681415022205298, 1.0995574287564276, 1.1309733552923256, 1.1623892818282235, 1.1938052083641213, 1.2252211349000193, 1.2566370614359172, 1.288052987971815, 1.3194689145077132, 1.350884841043611, 1.382300767579509, 1.413716694115407, 1.4451326206513047, 1.4765485471872029, 1.5079644737231006, 1.5393804002589986, 1.5707963267948966, 1.6022122533307945, 1.6336281798666925, 1.6650441064025905, 1.6964600329384882, 1.7278759594743862, 1.7592918860102842, 1.790707812546182, 1.8221237390820801, 1.853539665617978, 1.8849555921538756, 1.9163715186897738, 1.9477874452256716, 1.9792033717615698, 2.0106192982974678, 2.0420352248333655, 2.0734511513692637, 2.1048670779051615, 2.1362830044410597, 2.1676989309769574, 2.199114857512855, 2.2305307840487534, 2.261946710584651, 2.293362637120549, 2.324778563656447, 2.356194490192345, 2.3876104167282426, 2.419026343264141, 2.4504422698000385, 2.4818581963359367, 2.5132741228718345, 2.5446900494077322, 2.57610597594363, 2.6075219024795286, 2.6389378290154264, 2.670353755551324, 2.701769682087222, 2.7331856086231197, 2.764601535159018, 2.796017461694916, 2.827433388230814, 2.8588493147667116, 2.8902652413026093, 2.9216811678385075, 2.9530970943744057, 2.9845130209103035, 3.015928947446201, 3.0473448739820994, 3.078760800517997, 3.1101767270538954, 3.141592653589793, 3.173008580125691, 3.204424506661589, 3.235840433197487, 3.267256359733385, 3.2986722862692828, 3.330088212805181, 3.3615041393410787, 3.3929200658769765, 3.4243359924128742, 3.4557519189487724, 3.4871678454846706, 3.5185837720205684, 3.549999698556466, 3.581415625092364, 3.6128315516282625, 3.6442474781641603, 3.675663404700058, 3.707079331235956, 3.7384952577718535, 3.7699111843077513, 3.80132711084365, 3.8327430373795477, 3.8641589639154454, 3.895574890451343, 3.926990816987241, 3.9584067435231396, 3.9898226700590373, 4.0212385965949355, 4.052654523130833, 4.084070449666731, 4.115486376202629, 4.1469023027385274, 4.178318229274425, 4.209734155810323, 4.241150082346221, 4.272566008882119, 4.303981935418017, 4.335397861953915, 4.366813788489813, 4.39822971502571, 4.429645641561608, 4.461061568097507, 4.4924774946334045, 4.523893421169302, 4.5553093477052, 4.586725274241098, 4.618141200776996, 4.649557127312894, 4.680973053848792, 4.71238898038469, 4.743804906920587, 4.775220833456485, 4.806636759992384, 4.838052686528282, 4.869468613064179, 4.900884539600077, 4.932300466135975, 4.9637163926718735, 4.995132319207771, 5.026548245743669, 5.057964172279567, 5.0893800988154645, 5.120796025351362, 5.15221195188726, 5.183627878423158, 5.215043804959057, 5.246459731494955, 5.277875658030853, 5.3092915845667505, 5.340707511102648, 5.372123437638546, 5.403539364174444, 5.434955290710342, 5.466371217246239, 5.497787143782137, 5.529203070318036, 5.560618996853934, 5.592034923389832, 5.62345084992573, 5.654866776461628, 5.686282702997525, 5.717698629533423, 5.749114556069321, 5.780530482605219, 5.811946409141117, 5.843362335677015, 5.874778262212914, 5.906194188748811, 5.937610115284709, 5.969026041820607, 6.000441968356505, 6.031857894892402, 6.0632738214283, 6.094689747964199, 6.126105674500097, 6.157521601035994, 6.188937527571892, 6.220353454107791, 6.2517693806436885];
double sin_range[200] = {2.5, 2.578526897695321, 2.6569762988232832, 2.735270783296286, 2.8133330839107606, 2.891086162600577, 2.9684532864643116, 3.045358103491356, 3.1217247179121372, 3.197477765098073, 3.2725424859373686, 3.3468448006132285, 3.420311381711695, 3.4928697265869513, 3.5644482289126818, 3.634976249348867, 3.7043841852542885, 3.772603539375928, 3.8395669874474914, 3.9052084446303263, 3.969463130731183, 4.032267634132442, 4.093559974371724, 4.15327966330913, 4.211367764821722, 4.267766952966369, 4.322421568553529, 4.375277674076148, 4.426283106939473, 4.475387530939226, 4.522542485937368, 4.567701435686405, 4.610819813755038, 4.651855067509859, 4.690766700109659, 4.72751631047092, 4.762067631165049, 4.794386564209953, 4.824441214720628, 4.8522019223855635, 4.877641290737884, 4.900734214192358, 4.921457902821578, 4.939791904846868, 4.955718126821722, 4.969220851487845, 4.980286753286194, 4.9889049115077, 4.9950668210706795, 4.998766400914329, 5.0, 4.998766400914329, 4.9950668210706795, 4.9889049115077, 4.980286753286195, 4.969220851487845, 4.955718126821722, 4.939791904846869, 4.921457902821578, 4.900734214192358, 4.877641290737884, 4.8522019223855635, 4.824441214720629, 4.794386564209953, 4.762067631165049, 4.72751631047092, 4.690766700109659, 4.651855067509859, 4.610819813755038, 4.567701435686404, 4.522542485937368, 4.4753875309392255, 4.426283106939473, 4.375277674076149, 4.322421568553528, 4.267766952966369, 4.211367764821722, 4.15327966330913, 4.093559974371725, 4.032267634132441, 3.9694631307311834, 3.9052084446303272, 3.8395669874474923, 3.7726035393759276, 3.704384185254288, 3.634976249348867, 3.564448228912682, 3.4928697265869526, 3.4203113817116955, 3.346844800613228, 3.2725424859373686, 3.197477765098074, 3.121724717912138, 3.045358103491357, 2.9684532864643116, 2.8910861626005775, 2.813333083910761, 2.735270783296286, 2.656976298823284, 2.5785268976953204, 2.5000000000000004, 2.42147310230468, 2.3430237011767168, 2.2647292167037145, 2.1866669160892394, 2.108913837399423, 2.031546713535688, 1.9546418965086438, 1.8782752820878637, 1.8025222349019279, 1.7274575140626318, 1.6531551993867712, 1.5796886182883052, 1.507130273413049, 1.4355517710873194, 1.3650237506511322, 1.2956158147457115, 1.227396460624072, 1.1604330125525089, 1.0947915553696743, 1.0305368692688184, 0.9677323658675585, 0.9064400256282759, 0.8467203366908707, 0.7886322351782791, 0.7322330470336322, 0.677578431446471, 0.6247223259238512, 0.5737168930605265, 0.5246124690607741, 0.4774575140626318, 0.43229856431359615, 0.38918018624496176, 0.34814493249014067, 0.3092332998903409, 0.2724836895290803, 0.2379323688349504, 0.20561343579004676, 0.1755587852793714, 0.14779807761443653, 0.12235870926211634, 0.09926578580764245, 0.07854209717842187, 0.06020809515313141, 0.044281873178278364, 0.030779148512155796, 0.0197132467138057, 0.011095088492299787, 0.0049331789293209916, 0.001233599085670889, 0.0, 0.001233599085670889, 0.0049331789293209916, 0.011095088492299787, 0.019713246713805255, 0.030779148512155352, 0.044281873178278364, 0.06020809515313097, 0.07854209717842231, 0.09926578580764245, 0.1223587092621159, 0.14779807761443609, 0.17555878527937097, 0.20561343579004632, 0.2379323688349504, 0.272483689529079, 0.30923329989034176, 0.34814493249014156, 0.38918018624496264, 0.43229856431359526, 0.4774575140626309, 0.5246124690607734, 0.5737168930605261, 0.6247223259238499, 0.6775784314464697, 0.7322330470336291, 0.7886322351782775, 0.8467203366908711, 0.9064400256282759, 0.9677323658675587, 1.0305368692688166, 1.0947915553696728, 1.1604330125525073, 1.2273964606240702, 1.2956158147457097, 1.3650237506511327, 1.4355517710873176, 1.5071302734130492, 1.5796886182883054, 1.6531551993867715, 1.727457514062631, 1.8025222349019259, 1.8782752820878617, 1.9546418965086416, 2.0315467135356884, 2.108913837399422, 2.1866669160892385, 2.2647292167037127, 2.3430237011767168, 2.421473102304679};
double abs_sin_range[200] = {2.5, 2.5392682932795516, 2.578526897695321, 2.617766126774107, 2.6569762988232832, 2.6961477393196125, 2.735270783296286, 2.774335777727613, 2.8133330839107606, 2.8522530798439565, 2.891086162600577, 2.929822750698524, 2.9684532864643116, 3.0069682383912815, 3.045358103491356, 3.0836134096397636, 3.1217247179121372, 3.159682624913432, 3.197477765098073, 3.23510081308076, 3.2725424859373686, 3.3097935454953733, 3.3468448006132285, 3.3836871094481427, 3.420311381711695, 3.4567085809127245, 3.4928697265869513, 3.5287858965127716, 3.5644482289126818, 3.599847924639788, 3.634976249348867, 3.6698245356514336, 3.7043841852542885, 3.738646671081019, 3.772603539375928, 3.806246411789872, 3.8395669874474914, 3.8725570449953297, 3.9052084446303263, 3.9375131301081963, 3.969463130731183, 4.00105056331471, 4.032267634132442, 4.063106640839263, 4.093559974371724, 4.123620120825459, 4.15327966330913, 4.182531283774433, 4.211367764821722, 4.239781991480786, 4.267766952966369, 4.295315744407972, 4.322421568553529, 4.349077737446525, 4.375277674076148, 4.401014914000077, 4.426283106939473, 4.451076018345824, 4.475387530939226, 4.499211646217726, 4.522542485937368, 4.545374293562558, 4.567701435686405, 4.5895184034206755, 4.610819813755038, 4.6316004108852304, 4.651855067509859, 4.671578786095479, 4.690766700109659, 4.7094140752217335, 4.72751631047092, 4.7450689394015395, 4.762067631165049, 4.778508191588613, 4.794386564209953, 4.809698831278217, 4.824441214720628, 4.838610077074668, 4.8522019223855635, 4.865213397068864, 4.877641290737884, 4.889482536995825, 4.900734214192358, 4.911393546144495, 4.921457902821578, 4.930924800994191, 4.939791904846868, 4.948057026554414, 4.955718126821722, 4.962773315386935, 4.969220851487845, 4.975059144291394, 4.980286753286194, 4.984902388637949, 4.9889049115077, 4.992293334332819, 4.9950668210706795, 4.997224687404925, 4.998766400914329, 4.999691581204152, 5.0, 4.999691581204152, 4.998766400914329, 4.997224687404925, 4.9950668210706795, 4.992293334332819, 4.9889049115077, 4.984902388637949, 4.980286753286195, 4.975059144291395, 4.969220851487845, 4.962773315386935, 4.955718126821722, 4.948057026554414, 4.939791904846869, 4.930924800994191, 4.921457902821578, 4.911393546144495, 4.900734214192358, 4.889482536995826, 4.877641290737884, 4.865213397068864, 4.8522019223855635, 4.8386100770746685, 4.824441214720629, 4.809698831278217, 4.794386564209953, 4.778508191588614, 4.762067631165049, 4.7450689394015395, 4.72751631047092, 4.7094140752217335, 4.690766700109659, 4.671578786095478, 4.651855067509859, 4.6316004108852304, 4.610819813755038, 4.5895184034206755, 4.567701435686404, 4.545374293562558, 4.522542485937368, 4.499211646217726, 4.4753875309392255, 4.451076018345824, 4.426283106939473, 4.401014914000077, 4.375277674076149, 4.349077737446524, 4.322421568553528, 4.295315744407972, 4.267766952966369, 4.239781991480786, 4.211367764821722, 4.182531283774433, 4.15327966330913, 4.12362012082546, 4.093559974371725, 4.063106640839264, 4.032267634132441, 4.00105056331471, 3.9694631307311834, 3.9375131301081967, 3.9052084446303272, 3.87255704499533, 3.8395669874474923, 3.806246411789873, 3.7726035393759276, 3.7386466710810184, 3.704384185254288, 3.6698245356514336, 3.634976249348867, 3.5998479246397883, 3.564448228912682, 3.5287858965127725, 3.4928697265869526, 3.456708580912726, 3.4203113817116955, 3.383687109448142, 3.346844800613228, 3.3097935454953737, 3.2725424859373686, 3.23510081308076, 3.197477765098074, 3.159682624913433, 3.121724717912138, 3.0836134096397636, 3.045358103491357, 3.0069682383912806, 2.9684532864643116, 2.929822750698524, 2.8910861626005775, 2.8522530798439574, 2.813333083910761, 2.774335777727614, 2.735270783296286, 2.6961477393196125, 2.656976298823284, 2.6177661267741072, 2.5785268976953204, 2.5392682932795516};
double square_range[200] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5};
double triangle_range[200] = {0.0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.7499999999999999, 0.8, 0.8500000000000001, 0.9, 0.95, 1.0, 1.05, 1.1, 1.15, 1.2, 1.25, 1.3, 1.35, 1.4, 1.45, 1.4999999999999998, 1.55, 1.6, 1.6500000000000004, 1.7000000000000002, 1.75, 1.8, 1.8500000000000003, 1.9, 1.95, 2.0, 2.05, 2.1, 2.15, 2.2, 2.25, 2.3, 2.35, 2.4, 2.45, 2.5, 2.5500000000000003, 2.6, 2.6500000000000004, 2.7, 2.7499999999999996, 2.8, 2.8499999999999996, 2.9, 2.9499999999999997, 2.9999999999999996, 3.0500000000000003, 3.1, 3.1500000000000004, 3.2, 3.2500000000000004, 3.3000000000000007, 3.35, 3.4000000000000004, 3.45, 3.5, 3.5500000000000003, 3.6, 3.65, 3.7000000000000006, 3.7499999999999996, 3.8, 3.85, 3.9, 3.95, 4.0, 4.05, 4.1, 4.150000000000001, 4.2, 4.25, 4.3, 4.35, 4.4, 4.45, 4.5, 4.55, 4.6, 4.6499999999999995, 4.7, 4.75, 4.8, 4.8500000000000005, 4.9, 4.95, 5.0, 4.95, 4.8999999999999995, 4.8500000000000005, 4.8, 4.75, 4.699999999999999, 4.6499999999999995, 4.6000000000000005, 4.550000000000001, 4.5, 4.449999999999999, 4.3999999999999995, 4.35, 4.300000000000001, 4.249999999999999, 4.199999999999999, 4.1499999999999995, 4.1, 4.050000000000001, 4.000000000000001, 3.9499999999999993, 3.8999999999999995, 3.85, 3.8000000000000003, 3.750000000000001, 3.6999999999999993, 3.6499999999999995, 3.5999999999999996, 3.55, 3.5, 3.45, 3.399999999999999, 3.3499999999999996, 3.3, 3.25, 3.199999999999999, 3.149999999999999, 3.0999999999999996, 3.05, 3.0, 2.95, 2.899999999999999, 2.849999999999999, 2.7999999999999994, 2.75, 2.7, 2.649999999999999, 2.599999999999999, 2.5499999999999994, 2.5, 2.45, 2.4000000000000004, 2.349999999999999, 2.2999999999999994, 2.25, 2.2, 2.1500000000000004, 2.099999999999999, 2.0499999999999994, 2.0, 1.9500000000000002, 1.9000000000000004, 1.8500000000000005, 1.8000000000000012, 1.7500000000000013, 1.6999999999999988, 1.649999999999999, 1.5999999999999992, 1.5499999999999994, 1.5, 1.4500000000000002, 1.4000000000000004, 1.3500000000000005, 1.3000000000000007, 1.2500000000000013, 1.2000000000000002, 1.149999999999999, 1.0999999999999992, 1.0499999999999994, 1.0, 0.9500000000000002, 0.9000000000000004, 0.8500000000000005, 0.8000000000000007, 0.75, 0.7000000000000002, 0.6499999999999986, 0.5999999999999988, 0.5499999999999998, 0.5, 0.4500000000000002, 0.40000000000000036, 0.35000000000000053, 0.2999999999999998, 0.25, 0.20000000000000018, 0.15000000000000036, 0.09999999999999876, 0.04999999999999982};
double step_range[200] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
double tooth_saw_range[200] = {0.0, 0.025, 0.05, 0.075, 0.1, 0.125, 0.15, 0.175, 0.2, 0.225, 0.25, 0.275, 0.3, 0.325, 0.35, 0.37499999999999994, 0.4, 0.42500000000000004, 0.45, 0.475, 0.5, 0.525, 0.55, 0.575, 0.6, 0.625, 0.65, 0.675, 0.7, 0.725, 0.7499999999999999, 0.775, 0.8, 0.8250000000000002, 0.8500000000000001, 0.875, 0.9, 0.9250000000000002, 0.95, 0.975, 1.0, 1.025, 1.05, 1.075, 1.1, 1.125, 1.15, 1.175, 1.2, 1.225, 1.25, 1.2750000000000001, 1.3, 1.3250000000000002, 1.35, 1.3749999999999998, 1.4, 1.4249999999999998, 1.45, 1.4749999999999999, 1.4999999999999998, 1.5250000000000001, 1.55, 1.5750000000000002, 1.6, 1.6250000000000002, 1.6500000000000004, 1.675, 1.7000000000000002, 1.725, 1.75, 1.7750000000000001, 1.8, 1.825, 1.8500000000000003, 1.8749999999999998, 1.9, 1.925, 1.95, 1.975, 2.0, 2.025, 2.05, 2.0750000000000006, 2.1, 2.125, 2.15, 2.175, 2.2, 2.225, 2.25, 2.275, 2.3, 2.3249999999999997, 2.35, 2.375, 2.4, 2.4250000000000003, 2.45, 2.475, 2.5, 2.525, 2.5500000000000003, 2.5749999999999997, 2.6, 2.625, 2.6500000000000004, 2.675, 2.7, 2.7249999999999996, 2.7499999999999996, 2.7750000000000004, 2.8, 2.825, 2.8499999999999996, 2.8750000000000004, 2.9, 2.9250000000000003, 2.9499999999999997, 2.9749999999999996, 2.9999999999999996, 3.0250000000000004, 3.0500000000000003, 3.0749999999999997, 3.1, 3.1249999999999996, 3.1500000000000004, 3.175, 3.2, 3.225, 3.2500000000000004, 3.275, 3.3000000000000007, 3.325, 3.35, 3.375, 3.4000000000000004, 3.4250000000000003, 3.45, 3.4750000000000005, 3.5, 3.5249999999999995, 3.5500000000000003, 3.5750000000000006, 3.6, 3.625, 3.65, 3.6750000000000003, 3.7000000000000006, 3.725, 3.7499999999999996, 3.775, 3.8, 3.825, 3.85, 3.875, 3.9, 3.9249999999999994, 3.95, 3.9749999999999996, 4.0, 4.025, 4.05, 4.074999999999999, 4.1, 4.125, 4.150000000000001, 4.175000000000001, 4.2, 4.2250000000000005, 4.25, 4.2749999999999995, 4.3, 4.324999999999999, 4.35, 4.374999999999999, 4.4, 4.425, 4.45, 4.4750000000000005, 4.5, 4.5249999999999995, 4.55, 4.575, 4.6, 4.625, 4.6499999999999995, 4.675000000000001, 4.7, 4.7250000000000005, 4.75, 4.7749999999999995, 4.8, 4.824999999999999, 4.8500000000000005, 4.875, 4.9, 4.925, 4.95, 4.975};


void Init_spi() {
	// enabling clock for spi 1
	RCC->APB2ENR |= RCC_APB2ENR_SPI1EN;
	// PA4 TO PA7 -> ALTERNATIVE MODE.
	GPIOA->MODER |= (2<<8) | (2<<10) | (2<<14);
	// PA4: NSS, PA5: SCK, PA6:MISO, PA7: MOSI
	GPIOA->AFR[0] |= (5<<16) | (5<<20) | (5<<28);
	// BIDIMODE = 0, BIDIOE = 0, CRCEN = 0, CRCNEXT = 0, DFF = 1, RXONLY = 1, SSM = 0, SSI = 0, LSBFIRST = 0, SPE = 0, BR = 000, MSTR = 0, CPOL = 0, CPHA = 1.
	// 0000110000000001
	SPI1->CR1 = 0x0c01;
	//enabling:
	SPI1->CR1 |= (1<<6);
}

uint32_t analog_to_digital(double v_in){
	int result = round(v_in*4095/5);
	return (uint32_t) result;
}

void sin_wave(){
	int index = 0;
	int temp = 0;
	TIM5->CNT = 0;
	TIM2->CNT = 0;
	TIM5->ARR = 1000-1;
	TIM2->ARR = 5-1;
	TIM5->CR1 |= 1;
	TIM2->CR1 |= 1;
	while((TIM5->SR & 1) != 1);
	TIM5->SR &= ~(1);
	while((TIM2->SR & 1) != 1);
	TIM2->SR &= ~(1);
	TIM5->CNT = 0;
	TIM5->CR1 |= 1;
	while((TIM5->SR & 1) != 1) {
		GPIOC->ODR = analog_to_digital(tooth_saw_range[index]);
		index = (index+1)%200;
		while((TIM2->SR & 1) != 1);
		TIM2->SR &= ~(1);
	}
	TIM5->SR &= ~(1);
	TIM5->CR1 &= ~(1);
	TIM2->CR1 &= ~(1);
}

void rec_spi(uint32_t* data);

void print_data(uint32_t* data) {
	LCD_Clear();
	char msg[10];
	LCD_Puts(0, 0, "data1:");
	sprintf(msg, "%d", data[0]);
	LCD_Puts(8, 0, msg);
	LCD_Puts(0, 1, "2,3:");
	sprintf(msg, "%d", data[1]);
	LCD_Puts(5, 1, msg);
	sprintf(msg, "%d", data[2]);
	LCD_Puts(10, 1, msg);
}

void Init_gpio() {
	GPIOC->MODER = 0x555555;
	GPIOC->OSPEEDR = 0xAAAAAA;
	GPIOC->ODR = 0;
	GPIOB->MODER |= 1;
	GPIOB->OSPEEDR |= (1<<1);
	GPIOB->ODR = 0;
}

void Init_timers() {
	RCC->APB1ENR |= RCC_APB1ENR_TIM2EN;
	RCC->APB1ENR |= RCC_APB1ENR_TIM5EN;
	TIM2->PSC = 16-1;
	TIM2->CNT = 0;
	
	TIM5->PSC = 16000-1;
	TIM5->CNT = 0;
	TIM5->CR1 |= (1<<3);
}

void timer_warm_up() {
	TIM5->CNT = 0;
	TIM2->CNT = 0;
	TIM5->ARR = 5-1;
	TIM2->ARR = 5-1;
	TIM5->CR1 |= 1;
	TIM2->CR1 |= 1;
	while((TIM5->SR & 1) != 1);
	TIM5->SR &= ~(1);
	while((TIM2->SR & 1) != 1);
	TIM2->SR &= ~(1);
	TIM5->CR1 &= ~(1);
	TIM2->CR1 &= ~(1);
}

int main(void)
{
	SystemCoreClockUpdate();
	HAL_Init();
	
	__HAL_RCC_GPIOA_CLK_ENABLE();
	__HAL_RCC_GPIOB_CLK_ENABLE();
	__HAL_RCC_GPIOC_CLK_ENABLE();
	//LCD_Init();
	Init_gpio();
	Init_spi();
	Init_timers();
	timer_warm_up();
	uint32_t data[3] = {0, 0, 0};
	int index, i;
	double f_time;
	uint32_t arr_value;
	while (1) {
		index = 0;
		rec_spi(data);
		f_time = (1/(((double) data[1])*200)) * 1000000;
		arr_value = (uint32_t) round(f_time);
		TIM5->CNT = 0;
		TIM2->CNT = 0;
		TIM5->ARR = data[2]-1;
		TIM2->ARR = arr_value-1;
		TIM5->CR1 |= 1;
		TIM2->CR1 |= 1;
		while((TIM5->SR & 1) != 1) {
			while((TIM2->SR & 1) != 1);
			switch(data[0]) {
				case 1:
					GPIOC->ODR = analog_to_digital(sin_range[index]);
					index = (index+1)%200;
					break;
				case 2:
					GPIOC->ODR = analog_to_digital(square_range[index]);
					index = (index+1)%200;
					break;
				case 3:
					GPIOC->ODR = analog_to_digital(triangle_range[index]);
					index = (index+1)%200;
					break;
				case 4:
					GPIOC->ODR = analog_to_digital(abs_sin_range[index]);
					index = (index+1)%200;
					break;
				case 5:
					GPIOC->ODR = analog_to_digital(step_range[index]);
					index = (index+1)%200;
					break;
				case 6:
					GPIOC->ODR = analog_to_digital(tooth_saw_range[index]);
					index = (index+1)%200;
					break;
			}
			TIM2->SR &= ~(1);
		}
		TIM5->SR &= ~(1);
		TIM5->CR1 &= ~(1);
		TIM2->CR1 &= ~(1);
		GPIOC->ODR = 0;
		GPIOB->ODR = 1;
		for (i = 0; i < 10000; i++);
		GPIOB->ODR = 0;
	}
	return 0;
}

void rec_spi(uint32_t* data) {
	while((SPI1->SR & (1<<0)) == 0);
	data[0] = SPI1->DR;
	while((SPI1->SR & (1<<0)) == 0);
	data[1] = SPI1->DR;
	while((SPI1->SR & (1<<0)) == 0);
	data[2] = SPI1->DR;
}

void SysTick_Handler(void)
{
  HAL_IncTick();
}